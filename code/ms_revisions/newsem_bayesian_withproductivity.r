# Mediation model
# Source: http://lavaan.ugent.be/tutorial/mediation.html

# exogenous variables (T, P) are temperature and LAI, z-transformed 
# mediator (O) is overlap, logit-transformed
# endogenous variable (R) is Chao1 richness, z-transformed

semdat <- 
  structure(list(siteID = c("BART", "BLAN", "CPER", "GRSM", "HARV", 
                            "JERC", "JORN", "KONZ", "MOAB", "NIWO", "OAES", "ONAQ", "ORNL", 
                            "OSBS", "SCBI", "SERC", "STEI", "STER", "TALL", "TREE", "UKFS", 
                            "UNDE", "WOOD"), 
                 o = c(0.280087359701898, 0.610235589466509, 
                       -1.87844875098735, 0.638307849044372, 2.13873263027258, -2.95234923234684, 
                       -4.01129789291699, -1.24819684323377, -3.13386815593682, 1.30477938055795, 
                       -1.71013038540848, -3.8711889786639, -1.73881615699586, -1.33674817486503, 
                       -0.874278590275116, -0.168473581540691, 0.778582768874621, -0.886064855035078, 
                       -0.193311827816248, 1.7700962609674, -1.9238891609905, 0.336906497623836, 
                       0.00114853232086261), 
                 t = c(-0.983157854415803, 0.269153855886513, -0.409053263137938, 
                       0.282261024562685, -0.549443257222837, 1.61938951573856, 
                       0.933852990010343, 0.312012999845949, -0.106897767655547, 
                       -2.02603411541746, 0.914298970644232, -0.350863114964422, 
                       0.713144989073109, 1.92892692912945, 0.201262998747074, 
                       0.536662194128489, -1.20409661948428, -0.204045158505972, 
                       1.2330578474005, -1.13640708571057, 0.367790398205024, 
                       -1.22757605208951, -1.1142404247676), 
                 r = c(-2.14807586435342, -2.14807586435342,0.55397389144382, 
                       -2.14807586435342, -1.03546714137809, -1.19441124466028, 
                       0.712917994726011, -0.558634831531514, 1.03080620129039, 
                       -1.4063367157032, 0.0771415815972485, -0.240746624967133, 
                       -1.83018765778904, -1.19441124466028, -0.876523038095895, 
                       -2.4659640709178, -1.51229945122466, -0.558634831531514, 
                       -1.83018765778904, -1.83018765778904, -1.83018765778904, 
                       -1.19441124466028, -2.14807586435342), 
                 p = c(0.888526689995621, -0.122732505119302, -1.12205322258522, 
                       1.14916820243005, 1.97817166413782, -0.587274432218788,
                       -1.22047445606601, -0.625919379673411, -1.18643860274947, -0.752069565250409, 
                       -0.589130501345139, -0.954104182772006, 0.551538792074266, -0.405139165696203, 
                       0.204906411007614, 0.688784165296444, 0.71818858820521, -1.03216688499886, 
                       2.2248446067321, 0.604839360414692, -0.344818089203906, 0.755045762905219, 
                       -0.821693255520307)), 
            class = "data.frame", row.names = c(NA,-23L), .Names = c("siteID", "o", "t", "r", "p"))

mediation_model <- 
  '
  # direct effect
  r ~ e*t
  # mediator
  o ~ a*t + b*p
  r ~ c*o + f*p
  # indirect effect of temperature (a*c)
  ac := a*c
  # total effect of temperature
  totaltemp := e + (a*c)
  # indirect effect of productivity (b*c)
  bc := b*c
  # total effect of productivity
  totalprod := f + (b*c)
  # intercepts
  o ~ 1
  r ~ 1
  '

library(blavaan)

set.seed(27609)

mediation_fit <- blavaan(model = mediation_model, data = semdat,
                         auto.var = TRUE, auto.fix.first = TRUE, auto.cov.lv.x = TRUE,
                         jagcontrol = list(method = 'rjparallel'),
                         n.chains = 3, burnin = 5000, sample = 20000)

summary(mediation_fit)
parameterEstimates(mediation_fit)
inspect(mediation_fit, 'rsquare')
